#!/bin/sh

set -e

RUBY_DIR=$(find /app/vendor/ -maxdepth 1 -type d -name ruby-* | head -n1)
RUBY_PATH=$RUBY_DIR/bin/ruby
RUBY_2=$(${RUBY_PATH} -e 'print RUBY_VERSION >= "2.0"')

echo "here's what's in /app/vendor:"
echo $(ls -l /app/vendor)

BUILD_DIR=$1
echo "build dir: ${BUILD_DIR}"
echo "contents of build dir:"
echo $(ls -l ${BUILD_DIR})
echo "contents of build dir /vendor:"
echo $(ls -l ${BUILD_DIR}/vendor)

if [ "$RUBY_2" = "true" ]
then
  RUBY_BINARY_VERSION=$(${RUBY_PATH} -e "print RbConfig::CONFIG['ruby_version']")
  BUNDLE_HOME=vendor/bundle/ruby/$RUBY_BINARY_VERSION
  BUNDLE_BIN_PATH=vendor/bundle/bin
  BUNDLE_HOME_BIN_PATH=$BUNDLE_HOME/bin
  echo "Using Ruby 2: $(${RUBY_PATH} -v)"
else
  BUNDLE_HOME=vendor/bundle/1.8
  BUNDLE_BIN_PATH=vendor/bundle/bin
  BUNDLE_HOME_BIN_PATH=$BUNDLE_HOME/bin
  RUBY_PATH=/tmp/ruby-1.8.7/bin
fi

if [ -z "$3" ]
then
    echo "env argument not provided; skipping environment import"
else
    for file in $(ls $3)
    do
        eval "export $file='$(cat $3/$file)'"
    done
fi

if [ -z "$COMPILE_TASKS" ]
then
    echo 'No $COMPILE_TASKS detected'
else
    cd $1
    echo $RAILS_ENV
    env GEM_PATH=$BUNDLE_HOME PATH=$BUNDLE_BIN_PATH:$BUNDLE_HOME_BIN_PATH:$RUBY_PATH:$PATH bundle exec rake -t $COMPILE_TASKS 2>&1
fi
